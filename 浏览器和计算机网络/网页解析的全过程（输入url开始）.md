##  1.用户输入网址，浏览器发起DNS查询请求**

1. 浏览器根据地址去本身缓存中查找dns解析记录，如果有，则直接返回IP地址

   （查找的顺序：浏览器缓存-》系统缓存-》路由器缓存-》DNS）

   > 1. **浏览器缓存**：当用户通过浏览器访问某域名时，浏览器首先会在自己的缓存中查找是否有该域名对应的IP地址
   > 2. **系统缓存**：当浏览器缓存中无域名对应IP则会自动检查用户计算机系统Hosts文件DNS缓存是否有该域名对应IP
   > 3. **路由器缓存**：当浏览器及系统缓存中均无域名对应IP则进入路由器缓存中检查，以上三步均为客服端的DNS缓存
   > 4. **ISP（互联网服务提供商）DNS缓存**：当在用户客服端查找不到域名对应IP地址，则将进入ISP DNS缓存中进行查询。比如你用的是电信的网络，则会进入电信的DNS缓存服务器中进行查找。

2. 否则浏览器会查找操作系统中（**hosts文件**）是否有该域名的dns解析记录，如果有则返回。

3. 如果**浏览器缓存**和**操作系统hosts**中均无该域名的dns解析记录，或者已经过期，则会向**本地域名服务器**（LDNS）发起请求解析。如果有则返回，无则直接到**根域名解析器**请求解析

4. 根域名服务器会给LDNS返回一个所查询的**主域名服务器**（gTLDServer）地址。

5. LDNS 向 返回的主域名服务地址发起解析请求，主域名会返回请求对应的域名服务器地址（例如阿里dns,腾讯dns等）。

6. Name Server域名服务器会查存储的域名和IP的映射关系表，连同TTL值返回给本地域名服务器。

7. 本地域名服务器会缓存这个IP的对应关系，缓存时间由TTL控制。

8. 把解析结果返回给用户，用户根据TTL值缓存在本地系统中，域名解析过程结束。

   **注意**：主机向本地域名服务器的查询是**递归查询**，若没有，则本地域名服务器就以DNS客服的身份，向其他根域名服务器继续发出请求，此时采用的是**迭代查询**

   

   ![img](https://upload-images.jianshu.io/upload_images/7162582-ae5346bf961201e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800/format/webp)



1. ------

   从浏览器到本地DNS服务器属于递归查询，而DNS服务器之间属于迭代查询。

   DNS分为本地DNS服务器，根DNS服务器和各个子DNS服务器。

   ![img](https://upload-images.jianshu.io/upload_images/7162582-ae5346bf961201e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/800/format/webp)

   

## **2.建立TCP连接**(三次握手建立连接)

浏览器通过DNS获取到web服务器的IP地址后，便向web服务器发起tcp连接请求，通过TCP三次握手建立好连接后，浏览器便可以将HTTP请求数据通过发送给服务器了。

**握手**

1. Client将标志为SYN置为1，随机选取序列号**seq=x**, Client发出连接请求，进入**SYN-SENT**状态。
2. Server收到请求后，由标志位**SYN=1**得知Client请求连接，Server 将 标志位**SYN**和**ACK**置为1 ，**ack=x+1**，产生序列号**seq=y**, 发给Client确认连接请求，进入**SYN-RCVD**状态，此时操作系统为TCP连接分配TCP缓存和变量。
3. Client收到确认消息后，检查序列号**seq**是否等于**x+1**，**ACK **是否为1 ，正确则将 **ACK** 标志位置为1 ，**ack = y+1** ，并且此时操作系统为该 TCP 连接分配 TCP 缓存和变量，发送给 Server，Server 检查 **ack **是否为 **y + 1**，**ACK **是否为 1，如果正确则连接建立成功，Client 和 Server 进入 确认连接状态，完成三次握手

**注意**

* 不要将确认序号ack与标志位中的ACK搞混了。
* 确认方ack=发起方req+1，两端配对。

**补充四次挥手**

1. client 应用进程向TCP发出释放连接信息，终止数据发送，主动关闭TCP，进入等待状态。
2. Server收到连续释放报文段，发出确认报文段，进入关闭等待状态。
3. Server 发出连续释放报文段，Server处于最后确认状态，等待Client确认。
4. Client收到连续释放报文段后，发出确认释放报文段，Client处于时间等待状态，此时TCP未释放掉，需要经过时间等待计时器设置的时间2MSL**（MSL：报文最大生存时间）**后，Client进入关闭状态。

**为什么需要经过2MSL(最大报文段生存时间)才能进入关闭状态？**

如果Client发送的确认释放连接信息Server没有收到，这时候Server会再次发送一个释放连接请求，而这个时候Client还处于等待状态的话，还可以再次发送确认信息

## 3.浏览器向 web 服务器发送一个 HTTP 请求

1.  请求到达传输层，tcp协议为传输报文提供可靠的字节流传输服务，它通过三次握手等手段来保证传输过程中的安全可靠。通过对大块数据的分割成一个个报文段的方式提供给大量数据的便携传输。
2. 到网络层， 网络层通过ARP寻址得到接收方的Mac地址，IP协议把在传输层被分割成一个个数据包传送接收方。
3. 数据到达数据链路层，请求阶段完成。
4. 接收方在数据链路层收到数据包之后，层层传递到应用层，接收方应用程序就获得到请求报文。
5. 接收方收到发送方的HTTP请求之后，进行请求文件资源（如HTML页面）的寻找并响应报文。
6. 发送方收到响应报文后，如果报文中的状态码表示请求成功，则接受返回的资源（如HTML文件），进行页面渲染。



## 4. 发送响应数据给客户端

Web服务器通常通过监听80端口，来获取客户端的HTTP请求。与客户端建立好TCP连接后，web服务器开始接受客户端发来的数据，并通过HTTP解码，从接受到的网络数据中解析出请求的url信息以前其他诸如Accept-Encoding、Accept-Language等信息。Web服务器根据HTTP请求头的信息，得到响应数据返回给客户端。

至此，一个HTTP通信过程完成。web服务器会根据HTTP请求头中的Connection字段值决定是否关闭TCP链接通道，当Connection字段值为keep-alive时，web服务器不会立即关闭此连接。



## 5. 浏览器解析http response

1. html文档解析（DOM Tree）

   在浏览器没有完整接受全部HTML文档时，它就已经开始显示这个页面了。生成解析树即dom树，是由dom元素及属性节点组成，树的根是document对象。

2. 浏览器发送获取嵌入在HTML中的对象

   加载过程中遇到外部css文件，浏览器另外发出一个请求，来获取css文件。遇到图片资源，浏览器也会另外发出一个请求，来获取图片资源。这是异步请求，并不会影响html文档进行加载。但是当文档加载过程中遇到js文件，html文档会挂起渲染（加载解析渲染同步）的线程，不仅要等待文档中js文件加载完毕，还要等待解析执行完毕，才可以恢复html文档的渲染线程。

3. css解析（parser Render Tree）

   浏览器下载css文件，将css文件解析为样式表对象，并用来渲染dom tree。该对象包含css规则，该规则包含选择器和声明对象，css元素遍历的顺序，是从树的低端向上遍历。

4. js解析

   **浏览器UI线程**：单线程，大多数浏览器（比如chrome）让一个单线程共用于执行javascrip和更新用户界面，**js阻塞页面**：浏览器里的http请求被阻塞一般都是由js所引起，具体原因是js文件在下载完毕之后会立即执行，而js执行时候会阻塞浏览器的其他行为，有一段时间是没有网络请求被处理的，这段时间过后http请求才会接着执行，这段空闲时间就是所谓的http请求被阻塞。

   **js阻塞原因**：之所以会阻塞UI线程的执行，是因为js能控制UI的展示，而页面加载的规则是要顺序执行，所以在碰到js代码时候UI线程会首先执行它。



简单阐述

当用户输入域名之后，。首页根据域名查询它所对应的IP地址，浏览器首页会查看缓存，看是否有记录，缓存的查找一次为：浏览器缓存，系统缓存，路由器缓存。，如果没有，就查看系统的host文件，看是否是否记录。没有则查询DNS服务器。当获取到对应的IP地址后。就开始建立TCP连接，通过三次握手后，开始发送http请求。数据首页在传输层中通过字节流的方式进行传输，并将数据分割成一个个报文段来便携传输，接在在网络层中通过ARP寻址得到接收方的Mac地址，将数据发送个接受方，当数据到达数据链路层的时候，请求阶段完成，而接受方在数据链路层获得数据后，传递到应用层，这样接受方的应用程序就获得了请求报文。然后根据请求的资源信息来寻找对应的文件信息。然后发送数据给客户端，同时接收方会根据HTTP请求头的信息中Connection字段来决定是否关闭连接。浏览器根据返回的信息来解析渲染。首页是html文档的解析，当浏览器还没有完整的接受全部的HTML文档时，就已经开始显示了，解析过程中，当遇到css文件，或者图片等资源时，浏览器会另外发出一个请求去获取资源，这些都是异步请求，不会影响html文档的加载，但是当遇到Js文件时，html渲染线程就会被挂起，不仅要等待js文件加载完毕，还要等待解析执行完毕，才可以恢复html文档的渲染线程。

**js阻塞原因**：之所以会阻塞UI线程的执行，是因为js能控制UI的展示，而页面加载的规则是要顺序执行，所以在碰到js代码时候UI线程会首先执行它。

## 参考文献

1. [网页解析的全过程](https://www.cnblogs.com/wpshan/p/6282061.html)